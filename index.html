<!doctype html>
<html>
<head>
<title>Icinga to go</title>
<script type="text/javascript" src="jquery-1.10.2.min.js"></script>
<link rel="stylesheet" href="i.css"/>
</head>
<body>
<h1>Icinga to go</h1>
<div id="headlinks"></div>

<script type="text/javascript" src="demo.js"></script>
<script type="text/javascript">
var demo = true;
var url = '/icinga/cgi-bin/status.cgi?jsonoutput';
</script>
<script type="text/javascript">
var statuslist = {
	'CRIT' : {
		'Long' : 'CRITICAL',
		'Text' : 'Critial'
	},
	'WARN' : {
		'Long' : 'WARNING',
		'Text' : 'Warning'
	},
	'OK' : {
		'Long' : 'OK',
		'Text' : 'Ok'
	},
	'UNK' : {
		'Long' : 'UNKNOWN',
		'Text' : 'Unknown'
	},
	'PEND' : {
		'Long' : 'PENDING',
		'Text' : 'Pending'
	}
}

var createHeadLinks = function(statusgroups) {
	var parent = jQuery('#headlinks');
	jQuery.each(statuslist, function(i, e) {
		var a = document.createElement('a');
		a.className = i;
		a.href = '#' + i;
		a.innerText = i;
		if (e.Long in statusgroups) a.innerText += ' ' + statusgroups[e.Long].length;
		parent.append(a);
		parent.append(document.createTextNode(' '));
		});
}

var groupByStatus = function(data) {
	var groups = []
	jQuery.each(data, function(i,e) {
		group = e.status;
		if (!(group in groups)) groups[group] = [];
		groups[group].push(e);
		});
	return groups;
}

var processResult = function(data) {
	statusgroups = groupByStatus(data.status.service_status);
	createHeadLinks(statusgroups);
	
	var html = '';
	var lasthost = ''; var firsthost = true;
	jQuery.each(data.status.service_status, function(index, elem) {
		if (elem.host_name != lasthost) {
			if (!firsthost)
			{
				html += '</ul></li>';
			}
			html += '<li>' + elem.host_display_name + '<ul>';
			firsthost = false;
			lasthost = elem.host_name;
		}
		html += '<li>' + elem.service_display_name + ': ' + elem.status + '</li>';
	});
	if (html.length > 0) html += '</ul></li>';
	jQuery('#output').html(html);
}

if (demo) {processResult(response)} else
jQuery.getJSON(url, processResult);

</script>
</body>
</html>

